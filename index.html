<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Novo Agent - Chat Demo</title>

    <!-- External Dependencies (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .chat-container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 500px;
            height: 600px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .chat-header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .chat-header p {
            font-size: 0.875rem;
            opacity: 0.9;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 6px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: #f9fafb;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: 10px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 14px;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
        }

        .message-content {
            max-width: 70%;
        }

        .message-bubble {
            padding: 12px 16px;
            border-radius: 16px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .message.assistant .message-bubble {
            background: white;
            border: 1px solid #e5e7eb;
            border-top-left-radius: 4px;
        }

        .message.user .message-bubble {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-top-right-radius: 4px;
        }

        .message-time {
            font-size: 0.75rem;
            color: #9ca3af;
            margin-top: 4px;
            padding: 0 4px;
        }

        .message.user .message-time {
            text-align: right;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 0 10px;
        }

        .typing-indicator.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            border-top-left-radius: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #9ca3af;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        .chat-input-area {
            padding: 16px 20px;
            background: white;
            border-top: 1px solid #e5e7eb;
        }

        .input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 12px;
            font-size: 14px;
            font-family: inherit;
            resize: none;
            max-height: 120px;
            transition: border-color 0.2s;
        }

        .chat-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .send-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            min-width: 80px;
        }

        .send-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .send-button:active:not(:disabled) {
            transform: translateY(0);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 12px 16px;
            margin: 16px 20px 0;
            border-radius: 8px;
            font-size: 14px;
            display: none;
            animation: slideIn 0.3s ease-out;
        }

        .error-message.active {
            display: block;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 16px;
            z-index: 1000;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e5e7eb;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #6b7280;
            font-size: 14px;
        }

        /* Mobile Responsive */
        @media (max-width: 640px) {
            body {
                padding: 0;
                align-items: stretch;
            }

            .chat-container {
                max-width: 100%;
                height: 100vh;
                border-radius: 0;
            }

            .chat-header h1 {
                font-size: 1.25rem;
            }
        }

        /* Message Content Styling */
        .message-bubble p {
            margin: 0;
        }

        .message-bubble p + p {
            margin-top: 8px;
        }

        .message-bubble ul,
        .message-bubble ol {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-bubble code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.875em;
            font-family: 'Courier New', monospace;
        }

        .message.user .message-bubble code {
            background: rgba(255, 255, 255, 0.2);
        }

        .message-bubble pre {
            background: #f3f4f6;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 8px 0;
        }

        .message-bubble pre code {
            background: none;
            padding: 0;
        }

        .new-conversation-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.3);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .new-conversation-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-1px);
        }

        .new-conversation-btn:active {
            transform: translateY(0);
        }

        .new-conversation-btn svg {
            width: 16px;
            height: 16px;
        }

        .chat-header {
            position: relative;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">Connecting to Novo...</div>
        </div>

        <div class="chat-header">
            <h1>Novo Agent</h1>
            <p><span class="status-indicator"></span>Online & Ready</p>
            <button id="newConversationBtn" class="new-conversation-btn" title="Start a new conversation">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Chat
            </button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be appended here -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar">N</div>
            <div class="typing-dots">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea
                    id="chatInput"
                    class="chat-input"
                    placeholder="Type your message..."
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button">Send</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            API_BASE: 'https://mojeebapi.azurewebsites.net/api',
            WIDGET_ID: '58686180-0367-4fff-8d01-18ae10f7d70b',
            SUPABASE_URL: 'https://zssyyktaqahdfmehkdxn.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpzc3l5a3RhcWFoZGZtZWhrZHhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjUyNjYsImV4cCI6MjA2OTIwMTI2Nn0.6loB-m_y5To_zk3Inb7wvXSC00OOZ3FhMMTJMfdGlfg'
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            conversationId: null,
            agentId: null,
            guestId: null,
            supabaseClient: null,
            messageChannel: null,
            typingChannel: null,
            renderedMessageIds: new Set(),
            isSending: false
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            sendButton: document.getElementById('sendButton'),
            typingIndicator: document.getElementById('typingIndicator'),
            errorMessage: document.getElementById('errorMessage'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            newConversationBtn: document.getElementById('newConversationBtn')
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getOrCreateGuestId() {
            let guestId = localStorage.getItem('mojeeb_guest_id');
            if (!guestId) {
                guestId = generateUUID();
                localStorage.setItem('mojeeb_guest_id', guestId);
            }
            return guestId;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function scrollToBottom() {
            setTimeout(() => {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }, 100);
        }

        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.add('active');
            setTimeout(() => {
                elements.errorMessage.classList.remove('active');
            }, 5000);
        }

        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
        }

        // ============================================
        // MESSAGE RENDERING
        // ============================================

        function sanitizeAndParse(text) {
            try {
                const parsed = marked.parse(text);
                return DOMPurify.sanitize(parsed);
            } catch (error) {
                console.error('Error parsing markdown:', error);
                return DOMPurify.sanitize(text.replace(/</g, '&lt;').replace(/>/g, '&gt;'));
            }
        }

        function appendMessage(content, type, messageId, isOptimistic = false, timestamp = null) {
            // Avoid duplicate rendering
            if (messageId && state.renderedMessageIds.has(messageId)) {
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.dataset.messageId = messageId || `temp-${Date.now()}`;

            if (isOptimistic) {
                messageDiv.dataset.optimistic = 'true';
            }

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'U' : 'N';

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            if (type === 'assistant') {
                bubble.innerHTML = sanitizeAndParse(content);
            } else {
                bubble.textContent = content;
            }

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = timestamp ? formatTime(timestamp) : formatTime(new Date());

            contentWrapper.appendChild(bubble);
            contentWrapper.appendChild(timeDiv);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentWrapper);

            elements.chatMessages.appendChild(messageDiv);

            if (messageId) {
                state.renderedMessageIds.add(messageId);
            }

            scrollToBottom();
        }

        function replaceOptimisticMessage(serverMessage) {
            const optimisticMessages = elements.chatMessages.querySelectorAll('[data-optimistic="true"]');

            for (const msg of optimisticMessages) {
                const bubble = msg.querySelector('.message-bubble');
                if (bubble && bubble.textContent === serverMessage.message) {
                    // Remove optimistic message
                    msg.remove();
                    return true;
                }
            }

            return false;
        }

        // ============================================
        // TYPING INDICATOR
        // ============================================

        function showTypingIndicator() {
            elements.typingIndicator.classList.add('active');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            elements.typingIndicator.classList.remove('active');
        }

        // ============================================
        // API CALLS
        // ============================================

        async function initiateConversation() {
            const guestId = getOrCreateGuestId();

            // Check if we have an existing conversation
            const savedConversationId = localStorage.getItem('mojeeb_conversation_id');
            const savedAgentId = localStorage.getItem('mojeeb_agent_id');

            if (savedConversationId && savedAgentId) {
                state.conversationId = savedConversationId;
                state.agentId = savedAgentId;
                state.guestId = guestId;
                return { conversationId: savedConversationId, agentId: savedAgentId };
            }

            // Create new conversation
            const response = await fetch(`${CONFIG.API_BASE}/conversations/initiate-widget-conversation`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    widget_id: CONFIG.WIDGET_ID,
                    customer_name: 'Guest User',
                    customer_id: guestId,
                    customer_metadata: {
                        currentUrl: window.location.href,
                        deviceType: /mobile/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
                        language: navigator.language,
                        referrer: document.referrer || 'direct'
                    }
                })
            });

            if (!response.ok) {
                throw new Error('Failed to create conversation');
            }

            const data = await response.json();

            state.conversationId = data.id;
            state.agentId = data.agent_id;
            state.guestId = guestId;

            // Save to localStorage
            localStorage.setItem('mojeeb_conversation_id', data.id);
            localStorage.setItem('mojeeb_agent_id', data.agent_id);

            return data;
        }

        async function sendMessage(message) {
            if (state.isSending || !message.trim()) return;

            state.isSending = true;
            elements.sendButton.disabled = true;

            try {
                // Optimistically render user message
                const tempId = `temp-${Date.now()}`;
                appendMessage(message, 'user', tempId, true);

                // Clear input
                elements.chatInput.value = '';
                elements.chatInput.style.height = 'auto';

                // Send to API
                const response = await fetch(`${CONFIG.API_BASE}/chat/generate-response`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agentId: state.agentId,
                        conversationId: state.conversationId,
                        message: message,
                        messageType: 0,
                        senderId: state.guestId,
                        senderRole: 1
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to send message');
                }

                // Message will be updated via Supabase subscription

            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message. Please try again.');

                // Remove optimistic message on error
                const optimisticMsg = elements.chatMessages.querySelector(`[data-message-id="${tempId}"]`);
                if (optimisticMsg) {
                    optimisticMsg.remove();
                }
            } finally {
                state.isSending = false;
                elements.sendButton.disabled = false;
                elements.chatInput.focus();
            }
        }

        async function startNewConversation() {
            try {
                // Disable button during transition
                elements.newConversationBtn.disabled = true;
                elements.newConversationBtn.textContent = 'Starting...';

                // Step 1: Clear conversation ID from localStorage
                localStorage.removeItem('mojeeb_conversation_id');
                state.conversationId = null;

                // Step 2: Clear rendered message IDs
                state.renderedMessageIds.clear();

                // Step 3: Clear chat display (keep typing indicator)
                const typingIndicator = elements.typingIndicator;
                elements.chatMessages.innerHTML = '';
                elements.chatMessages.appendChild(typingIndicator);
                hideTypingIndicator();

                // Step 4: Unsubscribe from old Supabase channels
                if (state.typingChannel) {
                    await state.typingChannel.unsubscribe();
                    state.typingChannel = null;
                }

                if (state.messageChannel) {
                    await state.messageChannel.unsubscribe();
                    state.messageChannel = null;
                }

                // Step 5: Create new conversation
                await initiateConversation();

                // Step 6: Subscribe to new conversation
                subscribeToMessages();
                subscribeToTypingIndicator();

                // Step 7: Show welcome message
                appendMessage(
                    "Hi! I'm Novo, your AI assistant. How can I help you today?",
                    'assistant',
                    'welcome-' + Date.now(),
                    false
                );

                // Re-enable button
                elements.newConversationBtn.disabled = false;
                elements.newConversationBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Chat
                `;

                // Focus input
                elements.chatInput.focus();

            } catch (error) {
                console.error('Error starting new conversation:', error);
                showError('Failed to start new conversation. Please try again.');

                // Re-enable button
                elements.newConversationBtn.disabled = false;
                elements.newConversationBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Chat
                `;
            }
        }

        // ============================================
        // SUPABASE INTEGRATION
        // ============================================

        function initializeSupabase() {
            if (!window.supabase) {
                throw new Error('Supabase client not loaded');
            }

            state.supabaseClient = window.supabase.createClient(
                CONFIG.SUPABASE_URL,
                CONFIG.SUPABASE_ANON_KEY
            );
        }

        function subscribeToMessages() {
            if (!state.supabaseClient || !state.conversationId) return;

            // Subscribe to new messages
            state.messageChannel = state.supabaseClient
                .channel('public:chats')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'chats',
                    filter: `conversation_id=eq.${state.conversationId}`
                }, (payload) => {
                    const message = payload.new;

                    // Check if it's an optimistic update
                    if (replaceOptimisticMessage(message)) {
                        // Just update the message with real ID
                        appendMessage(
                            message.message,
                            message.sender_id === state.guestId ? 'user' : 'assistant',
                            message.id,
                            false,
                            message.created_at
                        );
                    } else {
                        // New message from agent
                        if (message.sender_id !== state.guestId) {
                            hideTypingIndicator();
                            appendMessage(
                                message.message,
                                'assistant',
                                message.id,
                                false,
                                message.created_at
                            );
                        }
                    }
                })
                .subscribe();
        }

        function subscribeToTypingIndicator() {
            if (!state.supabaseClient || !state.conversationId) return;

            state.typingChannel = state.supabaseClient
                .channel(`chat:${state.conversationId}`)
                .on('broadcast', { event: 'typing' }, (payload) => {
                    if (payload.payload?.is_typing) {
                        showTypingIndicator();
                    } else {
                        hideTypingIndicator();
                    }
                })
                .subscribe();
        }

        async function fetchHistoricalMessages() {
            if (!state.supabaseClient || !state.conversationId) return;

            try {
                const { data, error } = await state.supabaseClient
                    .from('chats')
                    .select('*')
                    .eq('conversation_id', state.conversationId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                if (data && data.length > 0) {
                    data.forEach(message => {
                        appendMessage(
                            message.message,
                            message.sender_id === state.guestId ? 'user' : 'assistant',
                            message.id,
                            false,
                            message.created_at
                        );
                    });
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        function handleSendClick() {
            const message = elements.chatInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        }

        function handleInputKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendClick();
            }
        }

        function handleInputChange() {
            // Auto-resize textarea
            elements.chatInput.style.height = 'auto';
            elements.chatInput.style.height = elements.chatInput.scrollHeight + 'px';
        }

        function handleNewConversationClick() {
            startNewConversation();
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        async function initialize() {
            try {
                // Check configuration
                if (CONFIG.WIDGET_ID === 'YOUR_WIDGET_ID_HERE' ||
                    CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                    throw new Error('Please configure WIDGET_ID, SUPABASE_URL, and SUPABASE_ANON_KEY in the script');
                }

                // Initialize Supabase
                initializeSupabase();

                // Create/resume conversation
                await initiateConversation();

                // Fetch historical messages
                await fetchHistoricalMessages();

                // Subscribe to real-time updates
                subscribeToMessages();
                subscribeToTypingIndicator();

                // Hide loading overlay
                hideLoading();

                // Show welcome message if no history
                if (elements.chatMessages.children.length === 0) {
                    appendMessage(
                        "Hi! I'm Novo, your AI assistant. How can I help you today?",
                        'assistant',
                        'welcome-' + Date.now(),
                        false
                    );
                }

                // Set up event listeners
                elements.sendButton.addEventListener('click', handleSendClick);
                elements.chatInput.addEventListener('keypress', handleInputKeyPress);
                elements.chatInput.addEventListener('input', handleInputChange);
                elements.newConversationBtn.addEventListener('click', handleNewConversationClick);

                // Focus input
                elements.chatInput.focus();

            } catch (error) {
                console.error('Initialization error:', error);
                hideLoading();
                showError('Failed to initialize chat: ' + error.message);
            }
        }

        // Start the application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
