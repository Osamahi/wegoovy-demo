<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wegovy - AI Assistant</title>

    <!-- External Dependencies (CDN) -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@12.0.0/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dompurify@3.0.8/dist/purify.min.js"></script>

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div class="chat-container">
        <div class="loading-overlay" id="loadingOverlay">
            <div class="spinner"></div>
            <div class="loading-text">Connecting to Wegovy...</div>
        </div>

        <div class="chat-header">
            <img src="wegovy-logo.png" alt="Wegovy" class="wegovy-logo">
            <p class="chat-subtitle"><span class="status-indicator"></span>AI Assistant - Here to Help</p>
            <button id="newConversationBtn" class="new-conversation-btn" title="Start a new conversation">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                New Chat
            </button>
        </div>

        <div class="chat-messages" id="chatMessages">
            <!-- Messages will be appended here -->
        </div>

        <div class="typing-indicator" id="typingIndicator">
            <div class="message-avatar">N</div>
            <div class="typing-dots">
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
                <span class="typing-dot"></span>
            </div>
        </div>

        <div class="error-message" id="errorMessage"></div>

        <div class="chat-input-area">
            <div class="input-wrapper">
                <textarea
                    id="chatInput"
                    class="chat-input"
                    placeholder="Type your message..."
                    rows="1"
                ></textarea>
                <button id="sendButton" class="send-button">Send</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            API_BASE: 'https://mojeebapi.azurewebsites.net/api',
            WIDGET_ID: '58686180-0367-4fff-8d01-18ae10f7d70b',
            SUPABASE_URL: 'https://zssyyktaqahdfmehkdxn.supabase.co',
            SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inpzc3l5a3RhcWFoZGZtZWhrZHhuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjUyNjYsImV4cCI6MjA2OTIwMTI2Nn0.6loB-m_y5To_zk3Inb7wvXSC00OOZ3FhMMTJMfdGlfg'
        };

        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const state = {
            conversationId: null,
            agentId: null,
            guestId: null,
            supabaseClient: null,
            messageChannel: null,
            typingChannel: null,
            renderedMessageIds: new Set(),
            isSending: false
        };

        // ============================================
        // DOM ELEMENTS
        // ============================================
        const elements = {
            chatMessages: document.getElementById('chatMessages'),
            chatInput: document.getElementById('chatInput'),
            sendButton: document.getElementById('sendButton'),
            typingIndicator: document.getElementById('typingIndicator'),
            errorMessage: document.getElementById('errorMessage'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            newConversationBtn: document.getElementById('newConversationBtn')
        };

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================

        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getOrCreateGuestId() {
            let guestId = localStorage.getItem('mojeeb_guest_id');
            if (!guestId) {
                guestId = generateUUID();
                localStorage.setItem('mojeeb_guest_id', guestId);
            }
            return guestId;
        }

        function formatTime(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleTimeString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        }

        function scrollToBottom() {
            setTimeout(() => {
                elements.chatMessages.scrollTop = elements.chatMessages.scrollHeight;
            }, 100);
        }

        function showError(message) {
            elements.errorMessage.textContent = message;
            elements.errorMessage.classList.add('active');
            setTimeout(() => {
                elements.errorMessage.classList.remove('active');
            }, 5000);
        }

        function hideLoading() {
            elements.loadingOverlay.classList.add('hidden');
        }

        // ============================================
        // MESSAGE RENDERING
        // ============================================

        function sanitizeAndParse(text) {
            try {
                const parsed = marked.parse(text);
                return DOMPurify.sanitize(parsed);
            } catch (error) {
                console.error('Error parsing markdown:', error);
                return DOMPurify.sanitize(text.replace(/</g, '&lt;').replace(/>/g, '&gt;'));
            }
        }

        function appendMessage(content, type, messageId, isOptimistic = false, timestamp = null) {
            // Avoid duplicate rendering
            if (messageId && state.renderedMessageIds.has(messageId)) {
                return;
            }

            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            messageDiv.dataset.messageId = messageId || `temp-${Date.now()}`;

            if (isOptimistic) {
                messageDiv.dataset.optimistic = 'true';
            }

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = type === 'user' ? 'U' : 'N';

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'message-content';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';

            if (type === 'assistant') {
                bubble.innerHTML = sanitizeAndParse(content);
            } else {
                bubble.textContent = content;
            }

            const timeDiv = document.createElement('div');
            timeDiv.className = 'message-time';
            timeDiv.textContent = timestamp ? formatTime(timestamp) : formatTime(new Date());

            contentWrapper.appendChild(bubble);
            contentWrapper.appendChild(timeDiv);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentWrapper);

            elements.chatMessages.appendChild(messageDiv);

            if (messageId) {
                state.renderedMessageIds.add(messageId);
            }

            scrollToBottom();
        }

        function replaceOptimisticMessage(serverMessage) {
            const optimisticMessages = elements.chatMessages.querySelectorAll('[data-optimistic="true"]');

            for (const msg of optimisticMessages) {
                const bubble = msg.querySelector('.message-bubble');
                if (bubble && bubble.textContent === serverMessage.message) {
                    // Remove optimistic message
                    msg.remove();
                    return true;
                }
            }

            return false;
        }

        // ============================================
        // TYPING INDICATOR
        // ============================================

        function showTypingIndicator() {
            elements.typingIndicator.classList.add('active');
            scrollToBottom();
        }

        function hideTypingIndicator() {
            elements.typingIndicator.classList.remove('active');
        }

        // ============================================
        // API CALLS
        // ============================================

        async function initiateConversation() {
            const guestId = getOrCreateGuestId();

            // Check if we have an existing conversation
            const savedConversationId = localStorage.getItem('mojeeb_conversation_id');
            const savedAgentId = localStorage.getItem('mojeeb_agent_id');

            if (savedConversationId && savedAgentId) {
                state.conversationId = savedConversationId;
                state.agentId = savedAgentId;
                state.guestId = guestId;
                return { conversationId: savedConversationId, agentId: savedAgentId };
            }

            // Create new conversation
            const response = await fetch(`${CONFIG.API_BASE}/conversations/initiate-widget-conversation`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    widget_id: CONFIG.WIDGET_ID,
                    customer_name: 'Guest User',
                    customer_id: guestId,
                    customer_metadata: {
                        currentUrl: window.location.href,
                        deviceType: /mobile/i.test(navigator.userAgent) ? 'mobile' : 'desktop',
                        language: navigator.language,
                        referrer: document.referrer || 'direct'
                    }
                })
            });

            if (!response.ok) {
                throw new Error('Failed to create conversation');
            }

            const data = await response.json();

            state.conversationId = data.id;
            state.agentId = data.agent_id;
            state.guestId = guestId;

            // Save to localStorage
            localStorage.setItem('mojeeb_conversation_id', data.id);
            localStorage.setItem('mojeeb_agent_id', data.agent_id);

            return data;
        }

        async function sendMessage(message) {
            if (state.isSending || !message.trim()) return;

            state.isSending = true;
            elements.sendButton.disabled = true;

            try {
                // Optimistically render user message
                const tempId = `temp-${Date.now()}`;
                appendMessage(message, 'user', tempId, true);

                // Clear input
                elements.chatInput.value = '';
                elements.chatInput.style.height = 'auto';

                // Send to API
                const response = await fetch(`${CONFIG.API_BASE}/chat/generate-response`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        agentId: state.agentId,
                        conversationId: state.conversationId,
                        message: message,
                        messageType: 0,
                        senderId: state.guestId,
                        senderRole: 1
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to send message');
                }

                // Message will be updated via Supabase subscription

            } catch (error) {
                console.error('Error sending message:', error);
                showError('Failed to send message. Please try again.');

                // Remove optimistic message on error
                const optimisticMsg = elements.chatMessages.querySelector(`[data-message-id="${tempId}"]`);
                if (optimisticMsg) {
                    optimisticMsg.remove();
                }
            } finally {
                state.isSending = false;
                elements.sendButton.disabled = false;
                elements.chatInput.focus();
            }
        }

        async function startNewConversation() {
            try {
                // Disable button during transition
                elements.newConversationBtn.disabled = true;
                elements.newConversationBtn.textContent = 'Starting...';

                // Step 1: Clear conversation ID from localStorage
                localStorage.removeItem('mojeeb_conversation_id');
                state.conversationId = null;

                // Step 2: Clear rendered message IDs
                state.renderedMessageIds.clear();

                // Step 3: Clear chat display (keep typing indicator)
                const typingIndicator = elements.typingIndicator;
                elements.chatMessages.innerHTML = '';
                elements.chatMessages.appendChild(typingIndicator);
                hideTypingIndicator();

                // Step 4: Unsubscribe from old Supabase channels
                if (state.typingChannel) {
                    await state.typingChannel.unsubscribe();
                    state.typingChannel = null;
                }

                if (state.messageChannel) {
                    await state.messageChannel.unsubscribe();
                    state.messageChannel = null;
                }

                // Step 5: Create new conversation
                await initiateConversation();

                // Step 6: Subscribe to new conversation
                subscribeToMessages();
                subscribeToTypingIndicator();

                // Step 7: Show welcome message
                appendMessage(
                    "Hi! I'm your Wegovy AI assistant. I'm here to help answer your questions about Wegovy and support you on your wellness journey. How can I help you today?",
                    'assistant',
                    'welcome-' + Date.now(),
                    false
                );

                // Re-enable button
                elements.newConversationBtn.disabled = false;
                elements.newConversationBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Chat
                `;

                // Focus input
                elements.chatInput.focus();

            } catch (error) {
                console.error('Error starting new conversation:', error);
                showError('Failed to start new conversation. Please try again.');

                // Re-enable button
                elements.newConversationBtn.disabled = false;
                elements.newConversationBtn.innerHTML = `
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Chat
                `;
            }
        }

        // ============================================
        // SUPABASE INTEGRATION
        // ============================================

        function initializeSupabase() {
            if (!window.supabase) {
                throw new Error('Supabase client not loaded');
            }

            state.supabaseClient = window.supabase.createClient(
                CONFIG.SUPABASE_URL,
                CONFIG.SUPABASE_ANON_KEY
            );
        }

        function subscribeToMessages() {
            if (!state.supabaseClient || !state.conversationId) return;

            // Subscribe to new messages
            state.messageChannel = state.supabaseClient
                .channel('public:chats')
                .on('postgres_changes', {
                    event: 'INSERT',
                    schema: 'public',
                    table: 'chats',
                    filter: `conversation_id=eq.${state.conversationId}`
                }, (payload) => {
                    const message = payload.new;

                    // Check if it's an optimistic update
                    if (replaceOptimisticMessage(message)) {
                        // Just update the message with real ID
                        appendMessage(
                            message.message,
                            message.sender_id === state.guestId ? 'user' : 'assistant',
                            message.id,
                            false,
                            message.created_at
                        );
                    } else {
                        // New message from agent
                        if (message.sender_id !== state.guestId) {
                            hideTypingIndicator();
                            appendMessage(
                                message.message,
                                'assistant',
                                message.id,
                                false,
                                message.created_at
                            );
                        }
                    }
                })
                .subscribe();
        }

        function subscribeToTypingIndicator() {
            if (!state.supabaseClient || !state.conversationId) return;

            state.typingChannel = state.supabaseClient
                .channel(`chat:${state.conversationId}`)
                .on('broadcast', { event: 'typing' }, (payload) => {
                    if (payload.payload?.is_typing) {
                        showTypingIndicator();
                    } else {
                        hideTypingIndicator();
                    }
                })
                .subscribe();
        }

        async function fetchHistoricalMessages() {
            if (!state.supabaseClient || !state.conversationId) return;

            try {
                const { data, error } = await state.supabaseClient
                    .from('chats')
                    .select('*')
                    .eq('conversation_id', state.conversationId)
                    .order('created_at', { ascending: true });

                if (error) throw error;

                if (data && data.length > 0) {
                    data.forEach(message => {
                        appendMessage(
                            message.message,
                            message.sender_id === state.guestId ? 'user' : 'assistant',
                            message.id,
                            false,
                            message.created_at
                        );
                    });
                }
            } catch (error) {
                console.error('Error fetching messages:', error);
            }
        }

        // ============================================
        // EVENT HANDLERS
        // ============================================

        function handleSendClick() {
            const message = elements.chatInput.value.trim();
            if (message) {
                sendMessage(message);
            }
        }

        function handleInputKeyPress(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                handleSendClick();
            }
        }

        function handleInputChange() {
            // Auto-resize textarea
            elements.chatInput.style.height = 'auto';
            elements.chatInput.style.height = elements.chatInput.scrollHeight + 'px';
        }

        function handleNewConversationClick() {
            startNewConversation();
        }

        // ============================================
        // INITIALIZATION
        // ============================================

        async function initialize() {
            try {
                // Check configuration
                if (CONFIG.WIDGET_ID === 'YOUR_WIDGET_ID_HERE' ||
                    CONFIG.SUPABASE_URL === 'YOUR_SUPABASE_URL') {
                    throw new Error('Please configure WIDGET_ID, SUPABASE_URL, and SUPABASE_ANON_KEY in the script');
                }

                // Initialize Supabase
                initializeSupabase();

                // Create/resume conversation
                await initiateConversation();

                // Fetch historical messages
                await fetchHistoricalMessages();

                // Subscribe to real-time updates
                subscribeToMessages();
                subscribeToTypingIndicator();

                // Hide loading overlay
                hideLoading();

                // Show welcome message if no history
                if (elements.chatMessages.children.length === 0) {
                    appendMessage(
                        "Hi! I'm your Wegovy AI assistant. I'm here to help answer your questions about Wegovy and support you on your wellness journey. How can I help you today?",
                        'assistant',
                        'welcome-' + Date.now(),
                        false
                    );
                }

                // Set up event listeners
                elements.sendButton.addEventListener('click', handleSendClick);
                elements.chatInput.addEventListener('keypress', handleInputKeyPress);
                elements.chatInput.addEventListener('input', handleInputChange);
                elements.newConversationBtn.addEventListener('click', handleNewConversationClick);

                // Focus input
                elements.chatInput.focus();

            } catch (error) {
                console.error('Initialization error:', error);
                hideLoading();
                showError('Failed to initialize chat: ' + error.message);
            }
        }

        // Start the application
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initialize);
        } else {
            initialize();
        }
    </script>
</body>
</html>
